<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jem Arnold">
<meta name="dcterms.date" content="2025-07-18">

<title>mNIRS Processing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="mNIRS-app_files/libs/clipboard/clipboard.min.js"></script>
<script src="mNIRS-app_files/libs/quarto-html/quarto.js"></script>
<script src="mNIRS-app_files/libs/quarto-html/popper.min.js"></script>
<script src="mNIRS-app_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="mNIRS-app_files/libs/quarto-html/anchor.min.js"></script>
<link href="mNIRS-app_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="mNIRS-app_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="mNIRS-app_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="mNIRS-app_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="mNIRS-app_files/libs/bootstrap/bootstrap-f9c3a980a829ab9d6a74b295b7269fb0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="mNIRS-app_files/libs/quarto-dashboard/quarto-dashboard.js"></script>
<script src="mNIRS-app_files/libs/quarto-dashboard/stickythead.js"></script>
<script src="mNIRS-app_files/libs/quarto-dashboard/datatables.min.js" kdttablesentinel="true"></script>
<script src="mNIRS-app_files/libs/quarto-dashboard/pdfmake.min.js" kdttablesentinel="true"></script>
<script src="mNIRS-app_files/libs/quarto-dashboard/vfs_fonts.js" kdttablesentinel="true"></script>
<script src="mNIRS-app_files/libs/quarto-dashboard/web-components.js" type="module"></script>
<script src="mNIRS-app_files/libs/quarto-dashboard/components.js"></script>
<link href="mNIRS-app_files/libs/quarto-dashboard/datatables.min.css" rel="stylesheet" kdttablesentinel="true">


</head>

<body class="quarto-dashboard dashboard-fill dashboard-sidebar fullcontent">

<header id="quarto-dashboard-header">
<nav class="navbar navbar-expand-md slim" data-bs-theme="dark">
  <div class="navbar-container container-fluid">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#dashboard-collapse" aria-controls="dashboard-collapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>    


    <div class="navbar-brand-container">       

      <div class="navbar-title">
        <div class="navbar-title-text"><a href="#">mNIRS Processing</a></div>
        
        <div class="navbar-author">Jem Arnold</div>
      </div>
    </div>
<div id="dashboard-collapse" class="navbar-collapse collapse"><ul class="navbar-nav navbar-nav-scroll me-auto" role="tablist"><li class="nav-item" role="presentation"><a id="tab-plot" class="nav-link active" data-bs-toggle="tab" role="tab" data-bs-target="#plot" data-scrolling="false" href="#plot" aria-controls="plot" aria-selected="true"><span class="nav-link-text">Plot</span></a></li><li class="nav-item" role="presentation"><a id="tab-data" class="nav-link" data-bs-toggle="tab" role="tab" data-bs-target="#data" data-scrolling="false" href="#data" aria-controls="data" aria-selected="false"><span class="nav-link-text">Data</span></a></li><li class="nav-item" role="presentation"><a id="tab-kinetics" class="nav-link" data-bs-toggle="tab" role="tab" data-bs-target="#kinetics" data-scrolling="false" href="#kinetics" aria-controls="kinetics" aria-selected="false"><span class="nav-link-text">Kinetics</span></a></li><li class="nav-item" role="presentation"><a id="tab-instructions" class="nav-link" data-bs-toggle="tab" role="tab" data-bs-target="#instructions" data-scrolling="false" href="#instructions" aria-controls="instructions" aria-selected="false"><span class="nav-link-text">Instructions</span></a></li></ul><div class="quarto-dashboard-links"><a class="quarto-dashboard-link" href="https://x.com/jem_arnold"><i class="bi bi-twitter"></i></a><a class="quarto-dashboard-link" href="https://github.com/jemarnold"><i class="bi bi-github"></i></a></div></div></div>
</nav>
</header>
<div class="page-layout-custom quarto-dashboard-content bslib-gap-spacing html-fill-container bslib-page-fill quarto-dashboard-pages">  

<div class="bslib-grid-item html-fill-item tab-content bslib-grid" data-layout="fill" style="display: grid; grid-template-rows: minmax(3em, 1fr); grid-auto-columns: minmax(0, 1fr);">
<div id="plot" class="dashboard-page tab-pane show active html-fill-item html-fill-container dashboard-sidebar-container" data-orientation="rows" aria-labelledby="tab-plot">
<div class="bslib-sidebar-layout html-fill-item html-fill-container" data-bslib-sidebar-open="desktop" data-bslib-sidebar-init="true" data-bslib-sidebar-border="false" data-bslib-sidebar-border-radius="false"><div class="main html-fill-container html-fill-item"><div class="sidebar-content html-fill-item html-fill-container">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-columns: minmax(3em, 1fr);
grid-auto-rows: minmax(0, 1fr);">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-rows: minmax(3em, 1fr); grid-auto-columns: minmax(0, 1fr);">
<div class="card cell html-fill-item html-fill-container bslib-card" data-bslib-card-init="" data-require-bs-caller="card()" data-full-screen="false">
<div class="card-body html-fill-item html-fill-container">
<div class="cell-output-display html-fill-item html-fill-container">
<div class="shiny-plot-output html-fill-item html-fill-container" id="plot" style="width:100%;height:400px;"></div>
</div>
</div>
<bslib-tooltip placement="auto" bsoptions="[]" data-require-bs-version="5" data-require-bs-caller="tooltip()">
    <template>Expand</template>
    <span class="bslib-full-screen-enter badge rounded-pill">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="height:1em;width:1em;" aria-hidden="true" role="img"><path d="M20 5C20 4.4 19.6 4 19 4H13C12.4 4 12 3.6 12 3C12 2.4 12.4 2 13 2H21C21.6 2 22 2.4 22 3V11C22 11.6 21.6 12 21 12C20.4 12 20 11.6 20 11V5ZM4 19C4 19.6 4.4 20 5 20H11C11.6 20 12 20.4 12 21C12 21.6 11.6 22 11 22H3C2.4 22 2 21.6 2 21V13C2 12.4 2.4 12 3 12C3.6 12 4 12.4 4 13V19Z"></path></svg>
    </span>
</bslib-tooltip><script data-bslib-card-init="">bslib.Card.initializeAllCards();</script></div>
</div>
</div>
</div></div><aside id="bslib-sidebar-1" class="sidebar html-fill-container html-fill-item"><div class="html-fill-item html-fill-container">
<div class="cell-output-display">
<br>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<label class="control-label shiny-label-null" for="upload_file" id="upload_file-label"></label>
<div class="input-group">
<label class="input-group-btn input-group-prepend">
<span class="btn btn-default btn-file">
Upload File
<input id="upload_file" class="shiny-input-file" name="upload_file" type="file" style="position: absolute !important; top: -99999px !important; left: -99999px !important;" accept=".xlsx,.xls,.csv,.CSV">
</span>
</label>
<input type="text" class="form-control" placeholder="No file selected" readonly="readonly">
</div>
<div id="upload_file_progress" class="progress active shiny-file-input-progress">
<div class="progress-bar"></div>
</div>
</div>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<label class="control-label" id="nirs_columns-label" for="nirs_columns">mNIRS Channel Names
(accepts multiple)</label>
<input id="nirs_columns" type="text" class="shiny-input-text form-control" value="" placeholder="new_name = file_name" data-update-on="blur">
</div>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<label class="control-label" id="sample_column-label" for="sample_column">Time/Sample Column Name</label>
<input id="sample_column" type="text" class="shiny-input-text form-control" value="" placeholder="new_name = file_name" data-update-on="blur">
</div>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<label class="control-label" id="event_column-label" for="event_column">Lap/Event Column Name</label>
<input id="event_column" type="text" class="shiny-input-text form-control" value="" placeholder="new_name = file_name" data-update-on="blur">
</div>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<label class="control-label" id="sample_rate-label" for="sample_rate">Sample Rate (estimated automatically)</label>
<input id="sample_rate" type="number" class="shiny-input-number form-control" value="0" data-update-on="change" min="0">
</div>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<label class="control-label" id="downsample_rate-label" for="downsample_rate">Downsample Rate</label>
<input id="downsample_rate" type="number" class="shiny-input-number form-control" value="0" data-update-on="change" min="0">
</div>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<label class="control-label" id="slice_head-label" for="slice_head">Remove Head Samples</label>
<input id="slice_head" type="number" class="shiny-input-number form-control" value="0" data-update-on="change" min="0" step="1">
</div>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<label class="control-label" id="slice_tail-label" for="slice_tail">Remove Tail Samples</label>
<input id="slice_tail" type="number" class="shiny-input-number form-control" value="0" data-update-on="change" min="0" step="1">
</div>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<label class="control-label" id="invalid_values-label" for="invalid_values">Replace Invalid Values</label>
<input id="invalid_values" type="text" class="shiny-input-text form-control" value="" placeholder="0, 100, ..." data-update-on="blur">
</div>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<div class="checkbox">
<label>
<input id="replace_outliers" type="checkbox" class="shiny-input-checkbox">
<span>Replace Outliers</span>
</label>
</div>
</div>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<div class="checkbox">
<label>
<input id="replace_missing" type="checkbox" class="shiny-input-checkbox">
<span>Replace Missing Values</span>
</label>
</div>
</div>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<div class="checkbox">
<label>
<input id="zero_start_time" type="checkbox" class="shiny-input-checkbox">
<span>Zero Start Time</span>
</label>
</div>
</div>
</div>
<div class="cell-output-display no-overflow-x">
<div class="form-group shiny-input-container">
<label class="control-label" id="filter_method-label" for="filter_method">Digital Filter Method</label>
<div>
<select id="filter_method" class="shiny-input-select"><option value="none" selected="">none</option>
<option value="smooth-spline">smooth-spline</option>
<option value="butterworth">butterworth</option>
<option value="moving-average">moving-average</option></select>
<script type="application/json" data-for="filter_method" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
<div class="cell-output-display no-overflow-x">
<div id="filter_method_ui" class="shiny-html-output"></div>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<div class="checkbox">
<label>
<input id="shift_logical" type="checkbox" class="shiny-input-checkbox">
<span>Shift Data</span>
</label>
</div>
</div>
</div>
<div class="cell-output-display no-overflow-x">
<div id="shift_data_ui" class="shiny-html-output"></div>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<div class="checkbox">
<label>
<input id="rescale_logical" type="checkbox" class="shiny-input-checkbox">
<span>Rescale Data</span>
</label>
</div>
</div>
</div>
<div class="cell-output-display no-overflow-x">
<div id="rescale_data_ui" class="shiny-html-output"></div>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<label class="control-label" id="manual_events-label" for="manual_events">Place Event Markers</label>
<input id="manual_events" type="text" class="shiny-input-text form-control" value="" placeholder="0, 100, ..." data-update-on="blur">
</div>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<div class="checkbox">
<label>
<input id="keep_all" type="checkbox" class="shiny-input-checkbox">
<span>Keep all Columns in File Export</span>
</label>
</div>
</div>
</div>
<div class="cell-output-display">
<a id="download_data" class="btn btn-default shiny-download-link disabled" href="" target="_blank" download="" aria-disabled="true" tabindex="-1">
<i class="fas fa-download" role="presentation" aria-label="download icon"></i>
Download Data
</a>
</div>
</div></aside>
<button class="collapse-toggle" type="button" title="Toggle sidebar" aria-expanded="true" aria-controls="bslib-sidebar-1">
    <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 16 16" class="bi bi-chevron-left collapse-icon" style="fill:currentColor;" aria-hidden="true" role="img">
      <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"></path>
    </svg>
</button>
<script data-bslib-sidebar-init="">
bslib.Sidebar.initCollapsibleAll()
</script>
</div>
</div>
<div id="data" class="dashboard-page tab-pane grid-skip html-fill-item html-fill-container" data-orientation="rows" aria-labelledby="tab-data">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-rows: minmax(3em, 1fr); grid-auto-columns: minmax(0, 1fr);">
<div class="card cell html-fill-item html-fill-container bslib-card" data-bslib-card-init="" data-require-bs-caller="card()" data-full-screen="false">
<div class="card-body html-fill-item html-fill-container">
<div class="cell-output-display html-fill-item html-fill-container">
<div class="datatables html-widget html-widget-output shiny-report-size html-fill-item html-fill-container" id="nirs_table" style="width:100%;height:auto;"></div>
</div>
</div>
<bslib-tooltip placement="auto" bsoptions="[]" data-require-bs-version="5" data-require-bs-caller="tooltip()">
    <template>Expand</template>
    <span class="bslib-full-screen-enter badge rounded-pill">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="height:1em;width:1em;" aria-hidden="true" role="img"><path d="M20 5C20 4.4 19.6 4 19 4H13C12.4 4 12 3.6 12 3C12 2.4 12.4 2 13 2H21C21.6 2 22 2.4 22 3V11C22 11.6 21.6 12 21 12C20.4 12 20 11.6 20 11V5ZM4 19C4 19.6 4.4 20 5 20H11C11.6 20 12 20.4 12 21C12 21.6 11.6 22 11 22H3C2.4 22 2 21.6 2 21V13C2 12.4 2.4 12 3 12C3.6 12 4 12.4 4 13V19Z"></path></svg>
    </span>
</bslib-tooltip><script data-bslib-card-init="">bslib.Card.initializeAllCards();</script></div>
</div>
</div>
<div id="kinetics" class="dashboard-page tab-pane grid-skip html-fill-item html-fill-container dashboard-sidebar-container" data-orientation="rows" aria-labelledby="tab-kinetics">
<div class="bslib-sidebar-layout html-fill-item html-fill-container" data-bslib-sidebar-open="desktop" data-bslib-sidebar-init="true"><div class="main html-fill-container html-fill-item"><div class="sidebar-content html-fill-item html-fill-container">

</div></div><aside id="bslib-sidebar-2" class="sidebar html-fill-container html-fill-item"><div class="html-fill-item html-fill-container">
<div class="cell-output cell-output-stdout">
<pre><code>Under Development</code></pre>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<label class="control-label" id="event_sample-label" for="event_sample">Sample Column Values to Detect Kinetics Start</label>
<input id="event_sample" type="text" class="shiny-input-text form-control" value="" placeholder="0, 100, ..." data-update-on="change">
</div>
</div>
<div class="cell-output-display">
<div class="form-group shiny-input-container">
<label class="control-label" id="event_label-label" for="event_label">Event Label to Detect Kinetics Start</label>
<input id="event_label" type="text" class="shiny-input-text form-control" value="" placeholder="start event" data-update-on="change">
</div>
</div>
</div></aside>
<button class="collapse-toggle" type="button" title="Toggle sidebar" aria-expanded="true" aria-controls="bslib-sidebar-2">
    <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 16 16" class="bi bi-chevron-left collapse-icon" style="fill:currentColor;" aria-hidden="true" role="img">
      <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"></path>
    </svg>
</button>
<script data-bslib-sidebar-init="">
bslib.Sidebar.initCollapsibleAll()
</script>
</div>
</div>
<div id="instructions" class="dashboard-page tab-pane grid-skip html-fill-item html-fill-container" data-orientation="rows" aria-labelledby="tab-instructions">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-rows: minmax(3em, max-content); grid-auto-columns: minmax(0, 1fr);">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-columns: minmax(3em, 1fr);
grid-auto-rows: minmax(0, 1fr);">
<div class="card html-fill-item html-fill-container bslib-card" data-fill="false" data-bslib-card-init="" data-require-bs-caller="card()" data-full-screen="false">
<div class="card-body html-fill-item html-fill-container">
<p><strong>Upload File:</strong> Upload an <code>.xlsx</code>, <code>.xls</code>, or <code>.csv</code> file containing mNIRS data. At the very least, this file should contain one column with an mNIRS data channel. Files exported directly from common NIRS devices in various formats should work.</p>
<p><strong>Channel Names:</strong> Enter the column names for the mNIRS data channels (e.g.&nbsp;<em>SmO2</em>, <em>HHb</em>, <em>TSI</em>), Sample column (e.g.&nbsp;<em>Time</em>), and Lap/Event column. Only a single mNIRS data channel column is required. Other columns can be left blank if not required / if they do not exist.</p>
<p>Data channels can be renamed with the format <code>new_name = file_column_name</code> (without quotes). Original column names must match the file contents exactly. Multiple names can be separated with commas, as <code>new_name1 = file_name1, new_name2 = file_name2</code>.</p>
<p>For example, from a <em>Moxy</em> .csv file: <em>NIRS Channel Names:</em> <code>smo2_left  = SmO2 Live</code>; <em>Sample Column Name:</em> <code>time = hh:mm:ss</code>; [<em>Lap/Event column</em> left blank].</p>
<p><strong>Sample Rate:</strong> Will be estimated automatically from the data, or can be overwritten explcitly. This is required for certain functions, including downsampling and proper digital filtering. Check the exported file sample times to confirm.</p>
<p><strong>Downsample Rate:</strong> Can be defined to downsample the data and reduce the number of output samples to improve signal to noise ratio.</p>
<p><strong>Remove Head/Tail Samples:</strong> Will remove samples from the start and end of the data, respectively. This can be used to omit invalid data at the head/tail of a recording, or to include only a particular selection of the entire data file. <code>&lt;under development: interactive graphical method to select portions of data&gt;</code></p>
<p><strong>Replace Invalid Values:</strong> A vector of numeric values can be defined to be explicitly removed and interpolated across, such as <code>0</code> and <code>100</code> when mNIRS sensors return invalid values.</p>
<p><strong>Replace Outliers:</strong> Will replace local outliers using a <code>Hampel</code> filter.</p>
<p><strong>Replace Missing Values:</strong> Will interpolate across missing (<code>NA</code>) samples.</p>
<p><strong>Zero Start Time:</strong> Reset the sample/time column to start from zero, for when selecting a subset of the data.</p>
<p><strong>Digital Filter Method:</strong> Choose a digital filter method from the drop-down options. The simplest option that works well for many datasets is a non-parametric <code>smooth-spline</code>.</p>
<p>A <code>Butterworth</code> filter can be defined to optimise the signal-to-noise ratio for your particular signal. The most common <em>Filter Type</em> is <code>"low-pass"</code>. <em>Filter Order (n)</em> should be an integer, typically between <code>[1:8]</code>. <em>Critical Frequency</em> should be a positive numeric value less than half of the sample rate, in Hz. <code>&lt;under development: interactive graphical method to compare digital filter methods&gt;</code></p>
<p><strong>Shift Data:</strong> Will shift mNIRS channels either together (with <em>Channels to Shift</em> = <code>"ensemble"</code>) or separately (with <code>"distinct"</code>) to the value specified by <em>Value to Shift</em>. <em>Position to Shift</em> defines which reference values from the data channel(s) to shift. <em>Samples to Shift</em> defines over how many samples to shift the mean value.</p>
<p>For example, each mNIRS channel can be shifted so that the first 30-sec mean value begins at zero, with the settings: <em>Value to Shift</em> = <code>0</code>; <em>Channels to Shift</em> = <code>"distinct"</code>; <em>Position to Shift</em> = <code>"first"</code>; <em>Samples to Shift</em> = <code>[30 * Sample Rate]</code> (equivalent to 30 seconds).</p>
<p><strong>Rescale Data:</strong> Will re-scale the mNIRS channels either together (<em>Channels to Rescale</em> = <code>"ensemble"</code>) or separately (with <code>"distinct"</code>) to the data range specified by <em>Rescale Range Minimum/Maximum</em>.</p>
<p>For example, all present mNIRS channels can be re-scaled so that the range of data are within range of <code>0-100</code>, preserving the relative scaling of each channel to the other, with the settings: <em>Rescale Range Minimum</em> = <code>0</code>; <em>Rescale Range Maximum</em> = <code>100</code>; <em>Channels to Rescale</em> = <code>"ensemble"</code>.</p>
<p><strong>Keep all columns in file export:</strong> Will keep all columns present from the original data file when exporting the processed file, along with the mNIRS, sample, and lap/event columns specified explicitly.</p>
<p><strong>Download Data:</strong> Will open a dialogue box to save an <code>.xlsx</code> file with the processed data to your system.</p>
<p><strong>Plot Tab:</strong> Specified mNIRS channels will be displayed in the <code>Plot</code> window and updated according to manually entered processing parameters.</p>
<p><strong>Data Tab:</strong> Processed data can be viewed in the <code>Data</code> window and will be updated according to the manually entered processing parameters.</p>
<p><strong>Kinetics Tab:</strong> <code>&lt;under development&gt;</code></p>
</div>
<bslib-tooltip placement="auto" bsoptions="[]" data-require-bs-version="5" data-require-bs-caller="tooltip()">
    <template>Expand</template>
    <span class="bslib-full-screen-enter badge rounded-pill">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="height:1em;width:1em;" aria-hidden="true" role="img"><path d="M20 5C20 4.4 19.6 4 19 4H13C12.4 4 12 3.6 12 3C12 2.4 12.4 2 13 2H21C21.6 2 22 2.4 22 3V11C22 11.6 21.6 12 21 12C20.4 12 20 11.6 20 11V5ZM4 19C4 19.6 4.4 20 5 20H11C11.6 20 12 20.4 12 21C12 21.6 11.6 22 11 22H3C2.4 22 2 21.6 2 21V13C2 12.4 2.4 12 3 12C3.6 12 4 12.4 4 13V19Z"></path></svg>
    </span>
</bslib-tooltip><script data-bslib-card-init="">bslib.Card.initializeAllCards();</script></div><div id="3ade8a4a-fb1d-4a6c-8409-ac45482d5fc9" class="hidden html-fill-item html-fill-container">

</div>
</div>
</div>
</div>
</div>
<p>
<script type="application/shiny-prerendered" data-context="server-start">
## install latest private repo from github
# devtools::install_github(
#     "jemarnold/mNIRS",
#     upgrade = "never",
#     auth_token = "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")

suppressPackageStartupMessages({
    library(bslib)
    library(shiny)
    library(DT)
    library(mNIRS)
    library(tidyverse)
})

options(digits = 5, digits.secs = 3, scipen = 3,
        dplyr.summarise.inform = FALSE,
        tibble.print_min = 20,
        shiny.maxRequestSize = 50*1024^2)

string_to_named_vector <- function(x) {
    noquotes <- gsub('["\\\"]', '', x)
    split_vec <- unlist(strsplit(noquotes, "\\s*,\\s*"))
    split_list <- strsplit(split_vec, "\\s*=\\s*")
    setNames(sapply(split_list, \(.x) trimws(last(.x))),
             sapply(split_list, \(.x) trimws(first(.x))))
}

# x <- '"Date = mm-dd", "Time = Time[hh:mm:ss]"'
# noquotes <- gsub('["\\\"]', '', x)
#     split_vec <- unlist(strsplit(noquotes, "\\s*,\\s*"))
#     split_list <- strsplit(split_vec, "\\s*=\\s*")
#     setNames(sapply(split_list, \(.x) trimws(.x[2])),
#              sapply(split_list, \(.x) trimws(.x[1])))


filtfilt_edges2 <- function (
        x,
        n = 1,
        W,
        type = c("low", "high", "stop", "pass"),
        edges = c("rev", "rep1", "none")
) {
    type = match.arg(type)
    edges = match.arg(edges)

    ## argument validation
    if (!is.numeric(x)) {
        cli::cli_abort("{.arg x} must be a numeric vector.")
    }
    if (!rlang::is_integerish(n) | n == 0) {
        cli::cli_abort("{.arg n} must be an integer scalar of 1 or greater.")
    }
    if (!is.numeric(W) | W == 0 | W == 1) {
        cli::cli_abort(paste(
            "{.arg W} must be a numeric scalar or two-element vector",
            "`c(low, high)` between 0 and 1."))
    }

    switch(edges,
           ## pads x with the first and last 10% of the vector length
           "rev" = pad_edges <- c(
               rev(head(x, length(x)/10)),
               x,
               rev(tail(x, length(x)/10))),
           ## pads x with repeating first / last value
           "rep1" = pad_edges <- c(
               rep(head(x, 1), length(x)/10),
               x,
               rep(tail(x, 1), length(x)/10)),
           "none" = pad_edges <- x
    )

    ## butterworth filter order (n) and relative cutoff frequency (W)
    x_filt <- signal::filtfilt(
        filt = signal::butter(n = n, W = W, type = type),
        x = pad_edges)

    ## returns the original vector length of x with padding omitted
    switch(edges,
           "rev" = x_filt[(length(x)/10 + 1):(length(x)/10 + length(x))],
           "rep1" = x_filt[(length(x)/10 + 1):(length(x)/10 + length(x))],
           "none" = x_filt)
}



</script>
 
<script type="application/shiny-prerendered" data-context="server-start">


## TODO
## DONE instructions
## action button
## split into laps by Lap/Event column
## -- either from one non-NA event value to the next, 
## -- or for all same lap values
## export laps to excel sheets
## kinetics stuff

br()

## Upload file
fileInput(
    "upload_file",
    label = NULL,
    buttonLabel = "Upload File",
    accept = c('.xlsx', '.xls', '.csv', '.CSV'),
)

## Tell it which columns are which
textInput(
    "nirs_columns", 
    label = "mNIRS Channel Names\n(accepts multiple)", 
    placeholder = "new_name = file_name",
    updateOn = "blur")
textInput(
    "sample_column", 
    label = "Time/Sample Column Name", 
    placeholder = "new_name = file_name",
    updateOn = "blur")
textInput(
    "event_column", 
    label = "Lap/Event Column Name", 
    placeholder = "new_name = file_name",
    updateOn = "blur")

numericInput("sample_rate", label = "Sample Rate (estimated automatically)", value = 0, min = 0)

numericInput("downsample_rate", label = "Downsample Rate", value = 0, min = 0)

## remove head/tail samples
numericInput("slice_head", label = "Remove Head Samples", 
             value = 0, min = 0, step = 1)
numericInput("slice_tail", label = "Remove Tail Samples", 
             value = 0, min = 0, step = 1)

## Replace invalid values (column wise)
textInput(
    "invalid_values",
    label = "Replace Invalid Values",
    placeholder = "0, 100, ...",
    updateOn = "blur")

## Replace outliers (column wise)
checkboxInput("replace_outliers", "Replace Outliers")

## Replace missing values (column wise)
checkboxInput("replace_missing", "Replace Missing Values")

## reset start time to zero
checkboxInput("zero_start_time", "Zero Start Time")

## Filter/smooth data (column wise)
selectInput(
    "filter_method",
    label = "Digital Filter Method",
    choices = c("none", "smooth-spline", "butterworth", "moving-average"))
uiOutput("filter_method_ui")

## Shift data (dataframe)
checkboxInput("shift_logical", "Shift Data")
uiOutput("shift_data_ui")

## rescale (dataframe)
checkboxInput("rescale_logical", "Rescale Data")
uiOutput("rescale_data_ui")

## place manual event lines in data
textInput(
    "manual_events",
    label = "Place Event Markers",
    placeholder = "0, 100, ...",
    updateOn = "blur")

checkboxInput("keep_all", "Keep all Columns in File Export")

downloadButton("download_data", "Download Data")

</script>
 
<script type="application/shiny-prerendered" data-context="server">
## set delay in case tab-out before full string completion
nirs_columns_debounced <- debounce(reactive(input$nirs_columns), 2000)
sample_column_debounced <- debounce(reactive(input$sample_column), 2000)
event_column_debounced <- debounce(reactive(input$event_column), 2000)
# nirs_columns_debounced <- reactive(input$nirs_columns)
# sample_column_debounced <- reactive(input$sample_column)
# event_column_debounced <- reactive(input$event_column)


# Data upload and processing
raw_data <- reactive({
    req(input$upload_file, nirs_columns_debounced(), sample_column_debounced())

    upload_file <- input$upload_file$datapath
    
    data <- mNIRS::read_data(
        file_path = upload_file,
        nirs_columns = string_to_named_vector(nirs_columns_debounced()),
        sample_column = string_to_named_vector(sample_column_debounced()),
        event_column = string_to_named_vector(event_column_debounced()),
        sample_rate = input$sample_rate,
        numeric_time = TRUE,
        keep_all = input$keep_all,
        verbose = FALSE)
    
    return(data)
})


## update `sample_rate`
observe({
    updateNumericInput(session, 
                       inputId = "sample_rate", 
                       value = attributes(raw_data())$sample_rate)
})

## Create dynamic UI for filter method
output$filter_method_ui <- renderUI({
    req(raw_data(), input$filter_method,
        nirs_columns_debounced(), sample_column_debounced())
    
    raw_data <- raw_data()
    sample_rate <- attributes(raw_data)$sample_rate
    
    # Different UI based on selection
    if (input$filter_method == "butterworth") {
        tagList(
            selectInput(
                "butter_type",
                label = "Butterworth Filter Type",
                choices = c("low", "high", "stop", "pass")),
            numericInput(
                "n",
                label = "Filter Order (n)",
                value = 2,
                min = 1,
                max = 10,
                step = 1),
            # numericInput(
            #   "W",
            #   label = "Fractional Critical Frequency (W)",
            #   value = 0.1,
            #   min = 0,
            #   max = 1,
            #   step = 0.01),
            numericInput(
                "critical_frequency",
                label = "Critical Frequency (Hz)",
                value = 0.1,
                min = 0,
                max = sample_rate/2,
                step = 0.05)
        )
    } else if (input$filter_method == "moving-average") {
        tagList(
            numericInput(
                "width",
                label = "width",
                value = 15,
                min = 1,
                step = 1)
        )
    } else {
        NULL
    }
})

## Create dynamic UI for shift option
output$shift_data_ui <- renderUI({
    req(raw_data(), input$shift_logical,
        nirs_columns_debounced(), sample_column_debounced())
    
    # Different UI based on selection
    if (input$shift_logical) {
        tagList(
            numericInput(
                "shift_value",
                label = "Value to Shift",
                value = 0),
            selectInput(
                "shift_which_cols",
                label = "Channels to Shift",
                choices = c("ensemble", "distinct")),
            selectInput(
                "shift_position",
                label = "Position to Shift",
                choices = c("minimum", "maximum", "first")),
            numericInput(
                "shift_samples",
                label = "Samples to Shift",
                value = 1),
        )
    }
})

## Create dynamic UI for rescale option
output$rescale_data_ui <- renderUI({
    req(raw_data(), input$rescale_logical,
        nirs_columns_debounced(), sample_column_debounced())
    
    # Different UI based on selection
    if (input$rescale_logical) {
        tagList(
            numericInput(
                "rescale_min",
                label = "Rescale Range Minimum",
                value = 0),
            numericInput(
                "rescale_max",
                label = "Rescale Range Maximum",
                value = 100),
            selectInput(
                "rescale_which_cols",
                label = "Channels to Rescale",
                choices = c("ensemble", "distinct")),
        )
    }
})



nirs_data <- reactive({
    req(raw_data(), nirs_columns_debounced(), sample_column_debounced())
    
    raw_data <- raw_data()
    nirs_columns <- attributes(raw_data)$nirs_columns
    sample_column <- attributes(raw_data)$sample_column
    event_column <- attributes(raw_data)$event_column
    sample_rate <- attributes(raw_data)$sample_rate
    invalid_values <- strsplit(input$invalid_values, split = "\\s*,\\s*")[[1]] |> 
        as.numeric()
    manual_events <- strsplit(input$manual_events, split = "\\s*,\\s*")[[1]] |> 
        as.numeric()
    
    nirs_data <- raw_data |> 
        mNIRS::downsample_data(
            sample_column = sample_column,
            sample_rate = sample_rate,
            downsample_rate = input$downsample_rate,
            verbose = FALSE
        ) |> 
        ## remove the head rows
        (\(.df) if (input$slice_head > 0) {
            slice_tail(.df, n = -input$slice_head)
            # filter(.df, .data[[sample_column]] > input$slice_head)
        } else {.df})() |> 
        ## remove the tail rows
        (\(.df) if (input$slice_tail > 0) {
            slice_head(.df, n = -input$slice_tail)
            # filter(.df, .data[[sample_column]] < input$slice_tail)
        } else {.df})() |> 
        mutate(
            if (input$replace_outliers) {
                across(
                    any_of(nirs_columns),
                    \(.x) mNIRS::replace_outliers(
                        .x, 
                        width = 5 * sample_rate,  ## 5-sec window
                        na.rm = TRUE, 
                        return = "median"))
            },
            if (!is.null(invalid_values)) {
                across(
                    any_of(nirs_columns),
                    \(.x) mNIRS::replace_invalid(
                        .x, 
                        values = invalid_values, 
                        width = 5 * sample_rate, ## 5-sec window
                        return = "median"))
            },
            if (input$replace_missing) {
                across(
                    any_of(nirs_columns),
                    \(.x) mNIRS::replace_missing(
                        .x, method = "linear", na.rm = TRUE))
            },
            if (input$filter_method == "smooth-spline") {
                across(
                    any_of(nirs_columns),
                    \(.x) mNIRS::filter_data(
                        .x, method = input$filter_method))
            } else if (input$filter_method == "butterworth") {
                req(input$n, input$critical_frequency)
                
                across(
                    any_of(nirs_columns),
                    # \(.x) mNIRS::filter_data(
                    #     .x, method = "butterworth",
                    #     type = input$butter_type,
                    #     n = input$n,
                    #     critical_frequency = input$critical_frequency,
                    #     sample_rate = sample_rate)
                    \(.x) filtfilt_edges2(
                        .x,
                        type = input$butter_type,
                        n = input$n,
                        W = input$critical_frequency / (sample_rate/2))
                )
            } else if (input$filter_method == "moving-average") {
                req(input$width)
                
                across(
                    any_of(nirs_columns),
                    \(.x) mNIRS::filter_data(
                        .x, method = input$filter_method, 
                        width = input$width))
            },
        ) |> 
        (\(.df) if (input$shift_logical) {
            req(input$shift_value, input$shift_position, 
                input$shift_which_cols, input$shift_samples)
            
            if (input$shift_which_cols == "ensemble") {
                shift_nirs_columns <- nirs_columns
            } else if (input$shift_which_cols == "distinct") {
                shift_nirs_columns <- as.list(nirs_columns)
            }
            
            mNIRS::shift_data(
                data = .df,
                nirs_columns = shift_nirs_columns,
                shift_to = input$shift_value,
                position = input$shift_position,
                mean_samples = input$shift_samples,
            )
        } else {.df})() |> 
        (\(.df) if (input$rescale_logical) {
            req(input$rescale_min, input$rescale_max, 
                input$rescale_which_cols)
            
            if (input$rescale_which_cols == "ensemble") {
                rescale_nirs_columns <- nirs_columns
            } else if (input$rescale_which_cols == "distinct") {
                rescale_nirs_columns <- as.list(nirs_columns)
            }
            
            mNIRS::rescale_data(
                data = .df,
                nirs_columns = rescale_nirs_columns,
                rescale_range = c(input$rescale_min, input$rescale_max)
            )
        } else {.df})() |> 
        mutate(
            ## reset sample/time values to zero
            if (input$zero_start_time) {
                across(any_of(sample_column), \(.x) .x - first(.x))  
            },
            event = if (isTruthy(manual_events) & !isTruthy(event_column)) {
                case_when(
                    .data[[sample_column]] %in% manual_events ~
                        as.character(.data[[sample_column]]),
                    TRUE ~ NA_character_)
            },
            if (isTruthy(manual_events) & isTruthy(event_column)) {
                across(any_of(event_column),
                       \(.x) case_when(
                           .data[[sample_column]] %in% manual_events ~
                               if(is.numeric(.x)) {
                                   .data[[sample_column]]   
                               } else {as.character(.data[[sample_column]])},
                           TRUE ~ .x)
                )
            },
            across(any_of(nirs_columns), \(.x) round(.x, 2)),
            # across(any_of(sample_column), 
            #        \(.x) round(.x * sample_rate) / sample_rate),
        )
    
    return(nirs_data)
    
})


output$nirs_table <- DT::renderDT({
    req(raw_data(), nirs_data())
    
    table <- DT::datatable(
        nirs_data(),
        options = list(
            pageLength = 25,
            scrollX = TRUE,
            searchHighlight = TRUE
        ))
    
    return(table)
})



output$plot <- renderPlot({
    req(raw_data(), nirs_data(), 
        nirs_columns_debounced(), sample_column_debounced())
    
    nirs_data <- nirs_data()
    manual_events <- strsplit(input$manual_events, split = "\\s*,\\s*")[[1]] |> 
        as.numeric()
    
    plot(nirs_data) +
        if (!is.null(manual_events)) {
            geom_vline(xintercept = manual_events, linetype = "dashed")
        } else {NULL}
})



output$download_data <- downloadHandler(
    
    filename = function() {
        paste0("mNIRS_processed_", Sys.time(), ".xlsx")
    },
    
    content = function(file) {
        writexl::write_xlsx(nirs_data(), path = file)
    }
)

</script>
 
<script type="application/shiny-prerendered" data-context="server-extras">
ojs_define <- function(..., .session = shiny::getDefaultReactiveDomain()) {
  quos <- rlang::enquos(...)
  vars <- rlang::list2(...)
  nm <- names(vars)
  if (is.null(nm)) {
    nm <- rep_len("", length(vars))
  }
  mapply(function(q, nm, val) {
    # Infer name, if possible
    if (nm == "") {
      tryCatch({
        nm <- rlang::as_name(q)
      }, error = function(e) {
        code <- paste(collapse = "\n", deparse(rlang::f_rhs(q)))
        stop("ojs_define() could not create a name for the argument: ", code)
      })
    }
    .session$output[[nm]] <- val
    outputOptions(.session$output, nm, suspendWhenHidden = FALSE)
    .session$sendCustomMessage("ojs-export", list(name = nm))
    NULL
  }, quos, nm, vars, SIMPLIFY = FALSE, USE.NAMES = FALSE)
  invisible()
}
</script>
</p>
<!--html_preserve-->
<script type="application/shiny-prerendered" data-context="dependencies">
{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.11.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["font-awesome"]},{"type":"character","attributes":{},"value":["6.5.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fontawesome"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["css/all.min.css","css/v4-shims.min.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fontawesome"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.3"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets"]},{"type":"character","attributes":{},"value":["1.6.4"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmlwidgets.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmlwidgets"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.6.4"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["datatables-css"]},{"type":"character","attributes":{},"value":["0.0.0"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets/css"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["datatables-crosstalk.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["DT"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.33"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["datatables-binding"]},{"type":"character","attributes":{},"value":["0.33"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["datatables.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["DT"]},{"type":"logical","attributes":{},"value":[false]},{"type":"character","attributes":{},"value":["0.33"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["jquery"]},{"type":"character","attributes":{},"value":["3.5.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["lib/jquery"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["jquery.min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["crosstalk"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.2.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["crosstalk"]},{"type":"character","attributes":{},"value":["1.2.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/crosstalk.min.js"]},{"type":"character","attributes":{},"value":["css/crosstalk.min.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["crosstalk"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.2.1"]}]}]}
</script>
<!--/html_preserve-->
<!--html_preserve-->
<script type="application/shiny-prerendered" data-context="execution_dependencies">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages","version"]},"class":{"type":"character","attributes":{},"value":["data.frame"]},"row.names":{"type":"integer","attributes":{},"value":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67]}},"value":[{"type":"character","attributes":{},"value":["base","bslib","cachem","cli","compiler","crosstalk","datasets","digest","dplyr","DT","evaluate","farver","fastmap","fontawesome","forcats","generics","ggplot2","glue","graphics","grDevices","grid","gtable","hms","htmltools","htmlwidgets","httpuv","jquerylib","jsonlite","knitr","later","lifecycle","lubridate","magrittr","memoise","methods","mime","mNIRS","pillar","pkgconfig","promises","purrr","R6","RColorBrewer","Rcpp","readr","rlang","rmarkdown","rstudioapi","sass","scales","shiny","stats","stringi","stringr","tibble","tidyr","tidyselect","tidyverse","timechange","tools","tzdb","utils","vctrs","withr","xfun","xtable","yaml"]},{"type":"character","attributes":{},"value":["4.5.0","0.9.0","1.1.0","3.6.5","4.5.0","1.2.1","4.5.0","0.6.37","1.1.4","0.33","1.0.4","2.1.2","1.2.0","0.5.3","1.0.0","0.1.4","3.5.2","1.8.0","4.5.0","4.5.0","4.5.0","0.3.6","1.1.3","0.5.8.1","1.6.4","1.6.16","0.1.4","2.0.0","1.50","1.4.2","1.0.4","1.9.4","2.0.3","2.0.1","4.5.0","0.13","0.0.0.9002","1.11.0","2.0.3","1.3.3","1.1.0","2.6.1","1.1-3","1.1.0","2.1.5","1.1.6","2.29","0.17.1","0.4.10","1.4.0","1.11.1","4.5.0","1.8.7","1.5.1","3.3.0","1.3.1","1.2.1","2.0.0","0.3.0","4.5.0","0.5.0","4.5.0","0.6.5","3.0.2","0.52","1.8-4","2.3.10"]}]}]}
</script>
<!--/html_preserve-->


<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /container fluid -->

<script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (_event) {
  if (window.bslib.Card) {
    window.bslib.Card.initializeAllCards();
  }
}); 
</script>
  



</body></html>