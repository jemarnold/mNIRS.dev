---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>",
    fig.path = "man/figures/README-",
    out.width = "100%"
)
```

# mnirs 
<!-- # mnirs <img src='man/figures/logo.png' align="right" height="240" /> -->

<!-- badges: start -->
[![R-CMD-check](https://github.com/jemarnold/mnirs/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/jemarnold/mnirs/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

`{mnirs}` is a package to allow for importing, processing, and analysing data 
from muscle near-infrared spectroscopy (mNIRS) devices.

## Installation

You can install the development version of `{mnirs}` from
[GitHub](https://github.com/jemarnold/mnirs) with:

``` r
# install.packages("remotes")
devtools::install_github("jemarnold/mnirs")
```

## Citation

...

## Online App

A very basic implementation of this package is hosted at https://jem-arnold.shinyapps.io/mnirs-app/
and can be used for mnirs data importing and cleaning.

## Usage

### Read data from file

```{r}

library(dplyr, warn.conflicts = FALSE)  ## load for data wrangling
library(ggplot2) ## load for plotting
library(mnirs)

## {mnirs} includes sample files from a few NIRS devices
file_path <- system.file("extdata/moxy_ramp_example.xlsx", package = "mnirs")

## rename channels in the format `new_name1 = "file_column_name1"`
## where "file_column_name1" should match the file column name exactly
data_raw <- read_data(file_path,
                      nirs_channels = c(smo2_left = "SmO2 Live",
                                        smo2_right = "SmO2 Live(2)"),
                      sample_channel = c(time = "hh:mm:ss"),
                      event_channel = c(lap = "Lap"),
                      sample_rate = 2,
                      time_to_numeric = TRUE,
                      time_from_zero = TRUE,
                      keep_all = FALSE,
                      verbose = FALSE)

data_raw

plot(data_raw)
```


### Replace outliers, invalid values, and missing Values

```{r}

## metadata are stored in dataframe attributes
nirs_channels <- attributes(data_raw)$nirs_channels
sample_rate <- attributes(data_raw)$sample_rate

data_cleaned <- data_raw |> 
    mutate(
        across(any_of(nirs_channels), 
               \(.x) replace_invalid(x = .x,
                                     values = c(0, 100),
                                     return = "NA")
        ),
        across(any_of(nirs_channels), 
               \(.x) replace_outliers(x = .x,
                                      width = 15, ## 15 sample median window
                                      t0 = 3,
                                      na.rm = TRUE,
                                      return = "median")
        ),
        across(any_of(nirs_channels), 
               \(.x) replace_missing(x = .x,
                                     method = "linear",
                                     na.rm = FALSE,
                                     maxgap = Inf)
        ),
    )

data_cleaned

plot(data_cleaned)
```


### Resample data

```{r}

data_downsampled <- data_cleaned |> 
    resample_data(sample_channel = NULL, ## will be automatically read from metadata
                  sample_rate = NULL, ## will be automatically read from metadata
                  resample_time = 10, ## equal to `resample_rate = 0.1`
                  na.rm = TRUE) ## interpolate across missing data appropriately

data_downsampled

plot(data_downsampled)
```


### Filter (smooth) data

```{r}
data_filtered <- data_cleaned |> 
    mutate(
        across(any_of(nirs_channels),
               \(.x) filter_data(x = .x,
                                 method = "butterworth",
                                 type = "low",
                                 n = 2, ## see ?filter_data for details on filter parameters
                                 W = 0.02)
        )
    )

data_filtered

plot(data_filtered)
```


### Shift and rescale data

```{r}
data_shifted <- data_filtered |> 
    ## convert `nirs_channels` to separate list items to shift each channel separately
    shift_data(nirs_channels = as.list(nirs_channels),
               sample_channel = NULL, ## we can leave this null since `sample_channel` is in our metadata
               shift_to = 0,
               position = "first",
               span = 120) ## shift the mean of the first 120 sec of data to zero

data_shifted

plot(data_shifted)
```


```{r}
data_rescaled <- data_filtered |> 
    ## convert `nirs_channels` vector to separate list items to shift each channel separately
    rescale_data(nirs_channels = as.list(nirs_channels), 
                 rescale_range = c(0, 100)) ## rescale to a 0-100% functional exercise range

data_rescaled

plot(data_rescaled)
```


### Process kinetics

`<under development>`

## mNIRS Device Compatibility

This package is designed to recognise mNIRS data exported as *.xlsx*, *.xls*, 
or *.csv* files.
It should be flexible for use with many different mNIRS devices, and 
compatibility will improve with continued development.

This package have been tested successfully with the following mNIRS devices:

* [Artinis](https://www.artinis.com/nirs-devices) Portamon and Oxymon
* [Moxy](https://www.moxymonitor.com/) 5 and 3
* [Train.Red](https://train.red/) FYER and Plus

This package have been tested successfully with mNIRS data exported from the 
following devices and apps:

* [Artinis Oxysoft](https://www.artinis.com/oxysoft) software (.csv and .xlsx)
* [Moxy](https://www.moxymonitor.com/) onboard export (.csv)
* [PerfPro](https://perfprostudio.com/) software (.xlsx)
* [Train.Red](https://train.red/) app (.csv)
* [VO2 Master Manager](https://vo2master.com/features/) app (.xlsx)
